<!DOCTYPE html>
<html>
<head>
    <title>Affirm Payment</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <form id="payment-form">
        <div id="payment-element"></div>
        <button id="submit-button">Pay with Affirm</button>
    </form>

    <script>
        const stripe = Stripe('pk_live_51P9Ull1EZLiysIlxLkg4tRxLgxxpD4Snm2xjJKgDS1C8gjPkKTU1wca2dNNUbVJ8Fn2MUR8Z55iNGGBqoSUh1fdu00mp1EMuWv');
        
        let elements;
        let paymentElement;

        async function initialize() {
            const response = await fetch('https://affirm-integration.onrender.com/create-payment-intent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    amount: 3500, // $35.00 in cents
                    currency: 'usd' 
                }),
            });
            
            const { client_secret } = await response.json();
            
            elements = stripe.elements({ clientSecret: client_secret });
            paymentElement = elements.create('payment', {
                paymentMethodTypes: ['affirm']
            });
            paymentElement.mount('#payment-element');
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            const { error, paymentIntent } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: window.location.origin + '/success.html',
                },
                redirect: 'if_required'
            });

            if (error) {
                console.error('Payment failed:', error);
            } else if (paymentIntent && paymentIntent.status === 'requires_capture') {
                // Auto-capture the payment
                await fetch('https://affirm-integration.onrender.com/capture-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payment_intent_id: paymentIntent.id })
                });
                window.location.href = '/success.html';
            }
        }

        document.getElementById('payment-form').addEventListener('submit', handleSubmit);
        initialize();
    </script>
</body>
</html>